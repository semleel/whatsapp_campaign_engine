generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model admin {
  admin_id        Int               @id @default(autoincrement())
  name            String?           @db.VarChar(100)
  email           String            @unique @db.VarChar(255)
  password_hash   String            @db.VarChar(255)
  role            String?           @db.VarChar(50)
  phone_num       String?           @db.VarChar(20)
  created_at      DateTime?         @default(now()) @db.Timestamp(6)
  is_active       Boolean?          @default(true)
  campaign        campaign[]
  session_token   session_token[]
  staff_privilege staff_privilege[]
  whatsapp_config whatsapp_config[]
}

model api {
  api_id            Int             @id @default(autoincrement())
  name              String          @db.VarChar(150)
  description       String?         @db.VarChar(500)
  method            String          @db.VarChar(20)
  auth_type         String?         @default("none") @db.VarChar(50)
  auth_header_name  String?         @default("Authorization") @db.VarChar(100)
  auth_token        String?         @db.VarChar(500)
  is_active         Boolean?        @default(true)
  last_updated      DateTime?       @db.Timestamp(6)
  response_template String?
  url               String
  headers_json      Json?
  body_template     Json?
  api_log           api_log[]
  campaign_step     campaign_step[]
}

model api_log {
  log_id              Int               @id @default(autoincrement())
  api_id              Int?
  campaign_id         Int?
  campaign_session_id Int?
  contact_id          Int?
  request_url         String?
  request_body        String?
  response_body       String?
  response_code       Int?
  status              String?           @db.VarChar(50)
  error_message       String?
  called_at           DateTime?         @default(now()) @db.Timestamp(6)
  step_id             Int?
  source              String?
  api                 api?              @relation(fields: [api_id], references: [api_id], onDelete: NoAction, onUpdate: NoAction)
  campaign            campaign?         @relation(fields: [campaign_id], references: [campaign_id], onDelete: NoAction, onUpdate: NoAction)
  campaign_session    campaign_session? @relation(fields: [campaign_session_id], references: [campaign_session_id], onDelete: NoAction, onUpdate: NoAction)
  contact             contact?          @relation(fields: [contact_id], references: [contact_id], onDelete: NoAction, onUpdate: NoAction)
}

model campaign {
  campaign_id           Int                    @id @default(autoincrement())
  campaign_name         String                 @db.VarChar(200)
  objective             String?                @db.VarChar(500)
  target_region_id      Int?
  status                String?                @default("Draft") @db.VarChar(50)
  created_by_admin_id   Int?
  created_at            DateTime?              @default(now()) @db.Timestamp(6)
  updated_at            DateTime?              @db.Timestamp(6)
  start_at              DateTime?              @db.Timestamp(6)
  end_at                DateTime?              @db.Timestamp(6)
  allow_repeat_join     Boolean                @default(true)
  max_joins_per_contact Int?
  opt_in_required       Boolean                @default(false)
  is_deleted            Boolean?
  is_active             Boolean?
  api_log               api_log[]
  admin                 admin?                 @relation(fields: [created_by_admin_id], references: [admin_id], onDelete: NoAction, onUpdate: NoAction)
  target_region         target_region?         @relation(fields: [target_region_id], references: [region_id], onDelete: NoAction, onUpdate: NoAction)
  campaign_keyword      campaign_keyword[]
  campaign_response     campaign_response[]
  campaign_session      campaign_session[]
  campaign_step         campaign_step[]
  campaign_step_choice  campaign_step_choice[]
  message               message[]
}

model campaign_keyword {
  keyword_id  Int      @id @default(autoincrement())
  value       String   @unique @db.VarChar(100)
  campaign_id Int
  campaign    campaign @relation(fields: [campaign_id], references: [campaign_id], onDelete: NoAction, onUpdate: NoAction)
}

model campaign_response {
  response_id          Int                   @id @default(autoincrement())
  session_id           Int
  campaign_id          Int
  step_id              Int
  choice_id            Int?
  user_input_raw       String?
  is_valid             Boolean?
  created_at           DateTime?             @default(now()) @db.Timestamp(6)
  campaign             campaign              @relation(fields: [campaign_id], references: [campaign_id], onDelete: NoAction, onUpdate: NoAction)
  campaign_step_choice campaign_step_choice? @relation(fields: [choice_id], references: [choice_id], onDelete: NoAction, onUpdate: NoAction)
  campaign_session     campaign_session      @relation(fields: [session_id], references: [campaign_session_id], onDelete: Cascade, onUpdate: NoAction)
  campaign_step        campaign_step         @relation(fields: [step_id], references: [step_id], onDelete: NoAction, onUpdate: NoAction)
}

model campaign_session {
  campaign_session_id Int                 @id @default(autoincrement())
  contact_id          Int
  campaign_id         Int?
  session_status      String?             @default("ACTIVE") @db.VarChar(50)
  created_at          DateTime?           @default(now()) @db.Timestamp(6)
  last_active_at      DateTime?           @db.Timestamp(6)
  current_step_id     Int?
  last_payload_json   Json?
  last_payload_type   String?             @db.VarChar
  required_inputs     Json?
  api_log             api_log[]
  campaign_response   campaign_response[]
  campaign            campaign?           @relation(fields: [campaign_id], references: [campaign_id], onDelete: NoAction, onUpdate: NoAction)
  contact             contact             @relation(fields: [contact_id], references: [contact_id], onDelete: NoAction, onUpdate: NoAction)
  campaign_step       campaign_step?      @relation(fields: [current_step_id], references: [step_id], onDelete: NoAction, onUpdate: NoAction, map: "campaign_session_current_step_fk")
  message             message[]
  service_feedback    service_feedback[]
  session_log         session_log[]
}

model campaign_step {
  step_id                                                               Int                    @id @default(autoincrement())
  campaign_id                                                           Int
  step_number                                                           Int
  step_code                                                             String?                @db.VarChar(100)
  prompt_text                                                           String
  expected_input                                                        String                 @db.VarChar(30)
  action_type                                                           String                 @db.VarChar(30)
  api_id                                                                Int?
  next_step_id                                                          Int?
  failure_step_id                                                       Int?
  is_end_step                                                           Boolean                @default(false)
  created_at                                                            DateTime?              @default(now()) @db.Timestamp(6)
  updated_at                                                            DateTime?              @db.Timestamp(6)
  error_message                                                         String?
  media_url                                                             String?
  template_source_id                                                    Int?
  choice_mode                                                           String                 @default("branch") @db.VarChar(20)
  interaction_config                                                    Json?
  campaign_response                                                     campaign_response[]
  campaign_session                                                      campaign_session[]
  api                                                                   api?                   @relation(fields: [api_id], references: [api_id], onDelete: NoAction, onUpdate: NoAction)
  campaign                                                              campaign               @relation(fields: [campaign_id], references: [campaign_id], onDelete: NoAction, onUpdate: NoAction)
  campaign_step_campaign_step_failure_step_idTocampaign_step            campaign_step?         @relation("campaign_step_failure_step_idTocampaign_step", fields: [failure_step_id], references: [step_id], onDelete: NoAction, onUpdate: NoAction, map: "campaign_step_failure_fk")
  other_campaign_step_campaign_step_failure_step_idTocampaign_step      campaign_step[]        @relation("campaign_step_failure_step_idTocampaign_step")
  campaign_step_campaign_step_next_step_idTocampaign_step               campaign_step?         @relation("campaign_step_next_step_idTocampaign_step", fields: [next_step_id], references: [step_id], onDelete: NoAction, onUpdate: NoAction, map: "campaign_step_next_fk")
  other_campaign_step_campaign_step_next_step_idTocampaign_step         campaign_step[]        @relation("campaign_step_next_step_idTocampaign_step")
  content                                                               content?               @relation(fields: [template_source_id], references: [content_id], onDelete: NoAction, onUpdate: NoAction)
  campaign_step_choice_campaign_step_choice_next_step_idTocampaign_step campaign_step_choice[] @relation("campaign_step_choice_next_step_idTocampaign_step")
  campaign_step_choice_campaign_step_choice_step_idTocampaign_step      campaign_step_choice[] @relation("campaign_step_choice_step_idTocampaign_step")
  session_log                                                           session_log[]

  @@unique([campaign_id, step_code], map: "campaign_step_unique_code_per_campaign")
  @@unique([campaign_id, step_number], map: "campaign_step_unique_number")
}

model campaign_step_choice {
  choice_id                                                      Int                 @id @default(autoincrement())
  campaign_id                                                    Int
  step_id                                                        Int
  choice_code                                                    String              @db.VarChar(100)
  label                                                          String
  next_step_id                                                   Int?
  is_correct                                                     Boolean?
  created_at                                                     DateTime?           @default(now()) @db.Timestamp(6)
  campaign_response                                              campaign_response[]
  campaign                                                       campaign            @relation(fields: [campaign_id], references: [campaign_id], onDelete: NoAction, onUpdate: NoAction)
  campaign_step_campaign_step_choice_next_step_idTocampaign_step campaign_step?      @relation("campaign_step_choice_next_step_idTocampaign_step", fields: [next_step_id], references: [step_id], onDelete: NoAction, onUpdate: NoAction)
  campaign_step_campaign_step_choice_step_idTocampaign_step      campaign_step       @relation("campaign_step_choice_step_idTocampaign_step", fields: [step_id], references: [step_id], onDelete: NoAction, onUpdate: NoAction)
}

model contact {
  contact_id       Int                @id @default(autoincrement())
  name             String?            @db.VarChar(100)
  phone_num        String             @unique @db.VarChar(30)
  email            String?            @db.VarChar(255)
  region_id        Int?
  created_at       DateTime?          @default(now()) @db.Timestamp(6)
  tos_accepted     Boolean?           @default(false)
  lang             String?            @db.VarChar(10)
  onboarded        Boolean?           @default(false)
  api_log          api_log[]
  campaign_session campaign_session[]
  target_region    target_region?     @relation(fields: [region_id], references: [region_id], onDelete: NoAction, onUpdate: NoAction)
  message          message[]
  service_feedback service_feedback[]
}

model content {
  content_id    Int             @id @default(autoincrement())
  title         String          @db.VarChar
  type          String?         @db.VarChar
  status        String?         @db.VarChar
  lang          String?         @db.VarChar
  body          String?
  media_url     String?         @db.VarChar
  placeholders  Json?
  created_at    DateTime?       @default(now()) @db.Timestamp(6)
  updated_at    DateTime?       @db.Timestamp(6)
  expires_at    DateTime?       @db.Timestamp(6)
  is_deleted    Boolean         @default(false)
  content_key   String?         @db.VarChar
  campaign_step campaign_step[]

  @@unique([content_key, lang], map: "content_key_lang_unique")
}

model delivery_log {
  delivery_id     Int       @id @default(autoincrement())
  message_id      Int
  delivery_status String?   @default("pending") @db.VarChar(50)
  retry_count     Int?      @default(0)
  last_attempt_at DateTime? @db.Timestamp(6)
  next_retry_at   DateTime? @db.Timestamp(6)
  provider_msg_id String?   @db.VarChar(255)
  error_message   String?
  created_at      DateTime? @default(now()) @db.Timestamp(6)
  message         message   @relation(fields: [message_id], references: [message_id], onDelete: NoAction, onUpdate: NoAction)
}

model message {
  message_id          Int               @id @default(autoincrement())
  campaign_id         Int?
  campaign_session_id Int?
  contact_id          Int?
  direction           String            @db.VarChar(20)
  sender_id           String?
  receiver_id         String?
  content_type        String?           @default("text") @db.VarChar(30)
  message_content     String?
  payload_json        String?
  message_status      String?           @default("pending") @db.VarChar(50)
  provider_msg_id     String?           @db.VarChar(255)
  error_message       String?
  created_at          DateTime?         @default(now()) @db.Timestamp(6)
  delivery_log        delivery_log[]
  campaign            campaign?         @relation(fields: [campaign_id], references: [campaign_id], onDelete: NoAction, onUpdate: NoAction)
  campaign_session    campaign_session? @relation(fields: [campaign_session_id], references: [campaign_session_id], onDelete: NoAction, onUpdate: NoAction)
  contact             contact?          @relation(fields: [contact_id], references: [contact_id], onDelete: NoAction, onUpdate: NoAction)
}

model service_feedback {
  feedback_id         Int               @id @default(autoincrement())
  contact_id          Int
  rating              Int?
  comment             String?
  created_at          DateTime?         @default(now()) @db.Timestamp(6)
  campaign_session_id Int?
  contact             contact           @relation(fields: [contact_id], references: [contact_id], onDelete: NoAction, onUpdate: NoAction, map: "campaign_feedback_contact_id_fkey")
  campaign_session    campaign_session? @relation(fields: [campaign_session_id], references: [campaign_session_id], onDelete: NoAction, onUpdate: NoAction)
}

model session_log {
  log_id              Int              @id @default(autoincrement())
  campaign_session_id Int
  step_id             Int?
  detail              String?          @db.VarChar(500)
  logged_at           DateTime?        @default(now()) @db.Timestamp(6)
  campaign_session    campaign_session @relation(fields: [campaign_session_id], references: [campaign_session_id], onDelete: NoAction, onUpdate: NoAction)
  campaign_step       campaign_step?   @relation(fields: [step_id], references: [step_id], onDelete: NoAction, onUpdate: NoAction, map: "session_log_step_fk")
}

model session_token {
  token_id     Int         @id @default(autoincrement())
  admin_id     Int?
  role_type    String      @db.VarChar(50)
  token_value  String      @db.VarChar(255)
  issued_at    DateTime?   @default(now()) @db.Timestamp(6)
  expiry_at    DateTime?   @db.Timestamp(6)
  is_revoked   Boolean?    @default(false)
  last_used_at DateTime?   @db.Timestamp(6)
  created_by   String?     @db.VarChar(100)
  created_at   DateTime?   @default(now()) @db.Timestamp(6)
  admin        admin?      @relation(fields: [admin_id], references: [admin_id], onDelete: NoAction, onUpdate: NoAction)
  token_log    token_log[]
}

model staff_privilege {
  privilege_id Int     @id @default(autoincrement())
  admin_id     Int
  resource     String  @db.VarChar(100)
  can_view     Boolean @default(false)
  can_create   Boolean @default(false)
  can_update   Boolean @default(false)
  can_archive  Boolean @default(false)
  admin        admin   @relation(fields: [admin_id], references: [admin_id], onDelete: NoAction, onUpdate: NoAction)
}

model system_command {
  command     String    @id @db.VarChar(50)
  description String?
  is_enabled  Boolean   @default(true)
  created_at  DateTime? @default(now()) @db.Timestamp(6)
}

model target_region {
  region_id   Int        @id @default(autoincrement())
  region_name String     @db.VarChar(100)
  region_code String     @db.VarChar(50)
  campaign    campaign[]
  contact     contact[]
}

model token_log {
  log_id        Int            @id @default(autoincrement())
  token_id      Int?
  action        String?        @db.VarChar(100)
  ip_address    String?        @db.VarChar(50)
  user_agent    String?
  log_time      DateTime?      @default(now()) @db.Timestamp(6)
  session_token session_token? @relation(fields: [token_id], references: [token_id], onDelete: NoAction, onUpdate: NoAction)
}

model whatsapp_config {
  id                  Int       @id @default(autoincrement())
  display_name        String?   @db.VarChar(255)
  phone_number        String    @db.VarChar(50)
  phone_number_id     String    @db.VarChar(100)
  waba_id             String?   @db.VarChar(100)
  verify_token        String    @db.VarChar(255)
  api_version         String?   @default("v21.0") @db.VarChar(20)
  is_active           Boolean?  @default(true)
  created_at          DateTime? @default(now()) @db.Timestamp(6)
  updated_at          DateTime? @db.Timestamp(6)
  updated_by_admin_id Int?
  admin               admin?    @relation(fields: [updated_by_admin_id], references: [admin_id], onDelete: NoAction, onUpdate: NoAction)
}
