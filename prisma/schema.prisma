generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model admin {
  adminid         Int               @id @default(autoincrement())
  name            String?           @db.VarChar
  email           String            @unique @db.VarChar
  password_hash   String            @db.VarChar
  role            String?           @db.VarChar
  phonenum        String?           @db.VarChar
  createdat       DateTime?         @default(now()) @db.Timestamp(6)
  is_active       Boolean?          @default(true)
  campaign        campaign[]
  sessiontoken    sessiontoken[]
  whatsapp_config whatsapp_config[]
  staff_privilege staff_privilege[]
}

model staff_privilege {
  privilegeid Int     @id @default(autoincrement())
  adminid     Int
  resource    String  @db.VarChar(100)
  view        Boolean @default(false)
  create      Boolean @default(false)
  update      Boolean @default(false)
  archive     Boolean @default(false)
  admin       admin   @relation(fields: [adminid], references: [adminid], onDelete: Cascade, onUpdate: NoAction)

  @@unique([adminid, resource], map: "ux_staff_privilege_admin_resource")
}

model allowedinput {
  allowedinputid Int        @id @default(autoincrement())
  triggerkey     String     @db.VarChar
  allowedvalue   String     @db.VarChar
  userflowid     Int
  keymapping     keymapping @relation(fields: [triggerkey, userflowid], references: [contentkeyid, userflowid], onDelete: Cascade, onUpdate: NoAction, map: "allowedinput_triggerkey_fkey")
}

model api {
  apiid                Int                    @id @default(autoincrement())
  name                 String                 @db.VarChar
  description          String?                @db.VarChar
  base_url             String                 @db.VarChar
  path                 String                 @db.VarChar
  method               String                 @db.VarChar
  auth_type            String?                @default("none") @db.VarChar
  auth_header_name     String?                @default("Authorization") @db.VarChar
  auth_token           String?                @db.VarChar
  timeout_ms           Int?                   @default(5000)
  retry_enabled        Boolean?               @default(false)
  retry_count          Int?                   @default(0)
  is_active            Boolean?               @default(true)
  lastupdated          DateTime?              @db.Timestamp(6)
  api_log              api_log[]
  apiparameter         apiparameter[]
  campaign_api_mapping campaign_api_mapping[]
}

model api_log {
  logid             Int              @id @default(autoincrement())
  apiid             Int?
  campaignid        Int?
  campaignsessionid Int?
  contactid         Int?
  request_url       String?
  request_body      String?
  response_body     String?
  response_code     Int?
  status            String?          @db.VarChar
  error_message     String?
  called_at         DateTime?        @default(now()) @db.Timestamp(6)
  api               api?             @relation(fields: [apiid], references: [apiid], onUpdate: NoAction)
  campaign          campaign?        @relation(fields: [campaignid], references: [campaignid], onUpdate: NoAction)
  campaignsession   campaignsession? @relation(fields: [campaignsessionid], references: [campaignsessionid], onUpdate: NoAction)
  contact           contact?         @relation(fields: [contactid], references: [contactid], onUpdate: NoAction)
}

model apiparameter {
  paramid       Int      @id @default(autoincrement())
  apiid         Int
  location      String   @db.VarChar
  key           String   @db.VarChar
  valuesource   String   @db.VarChar
  valuepath     String?  @db.VarChar
  constantvalue String?  @db.VarChar
  required      Boolean? @default(false)
  api           api      @relation(fields: [apiid], references: [apiid], onDelete: Cascade, onUpdate: NoAction)
}

model branchrule {
  branchruleid                                  Int        @id @default(autoincrement())
  triggerkey                                    String     @db.VarChar
  inputvalue                                    String     @db.VarChar
  nextkey                                       String     @db.VarChar
  priority                                      Int?       @default(1)
  userflowid                                    Int
  next_userflowid                               Int?
  userflow_branchrule_next_userflowidTouserflow userflow?  @relation("branchrule_next_userflowidTouserflow", fields: [next_userflowid], references: [userflowid], onUpdate: NoAction)
  keymapping                                    keymapping @relation(fields: [triggerkey, userflowid], references: [contentkeyid, userflowid], onDelete: Cascade, onUpdate: NoAction, map: "branchrule_triggerkey_fkey")
  userflow_branchrule_userflowidTouserflow      userflow   @relation("branchrule_userflowidTouserflow", fields: [userflowid], references: [userflowid], onDelete: Cascade, onUpdate: NoAction)
}

model campaign {
  campaignid           Int                    @id @default(autoincrement())
  campaignname         String                 @db.VarChar
  objective            String?                @db.VarChar
  targetregionid       Int?
  status               String?                @default("Draft") @db.VarChar
  createdby_adminid    Int?
  createdat            DateTime?              @default(now()) @db.Timestamp(6)
  updatedat            DateTime?              @db.Timestamp(6)
  start_at             DateTime?              @db.Timestamp(6)
  end_at               DateTime?              @db.Timestamp(6)
  userflowid           Int
  entry_contentkeyid   String?                @db.VarChar
  api_log              api_log[]
  admin                admin?                 @relation(fields: [createdby_adminid], references: [adminid], onUpdate: NoAction)
  keymapping           keymapping?            @relation(fields: [entry_contentkeyid, userflowid], references: [contentkeyid, userflowid], onDelete: SetNull, onUpdate: NoAction)
  targetregion         targetregion?          @relation(fields: [targetregionid], references: [regionid], onUpdate: NoAction)
  userflow             userflow               @relation(fields: [userflowid], references: [userflowid], onUpdate: NoAction)
  campaign_api_mapping campaign_api_mapping[]
  campaign_content     campaign_content[]
  campaignsession      campaignsession[]
  keyword              keyword[]
}

model campaign_api_mapping {
  mappingid            Int      @id @default(autoincrement())
  campaignid           Int
  contentkeyid         String   @db.VarChar
  apiid                Int
  success_contentkeyid String?  @db.VarChar
  error_contentkeyid   String?  @db.VarChar
  is_active            Boolean? @default(true)
  api                  api      @relation(fields: [apiid], references: [apiid], onUpdate: NoAction)
  campaign             campaign @relation(fields: [campaignid], references: [campaignid], onDelete: Cascade, onUpdate: NoAction)
}

model campaignsession {
  campaignsessionid  Int          @id @default(autoincrement())
  contactid          Int
  campaignid         Int?
  checkpoint         String?      @db.VarChar
  sessionstatus      String?      @default("ACTIVE") @db.VarChar
  createdat          DateTime?    @default(now()) @db.Timestamp(6)
  lastactiveat       DateTime?    @db.Timestamp(6)
  current_userflowid Int?
  api_log            api_log[]
  campaign           campaign?    @relation(fields: [campaignid], references: [campaignid], onUpdate: NoAction)
  contact            contact      @relation(fields: [contactid], references: [contactid], onDelete: Cascade, onUpdate: NoAction)
  userflow           userflow?    @relation(fields: [current_userflowid], references: [userflowid], onUpdate: NoAction)
  message            message[]
  sessionlog         sessionlog[]
}

model contact {
  contactid       Int               @id @default(autoincrement())
  name            String?           @db.VarChar
  phonenum        String            @unique @db.VarChar
  email           String?           @db.VarChar
  regionid        Int?
  createdat       DateTime?         @default(now()) @db.Timestamp(6)
  tos_accepted    Boolean?          @default(false)
  lang            String?           @db.VarChar
  onboarded       Boolean?          @default(false)
  api_log         api_log[]
  campaignsession campaignsession[]
  targetregion    targetregion?     @relation(fields: [regionid], references: [regionid], onUpdate: NoAction)
  message         message[]
}

model content {
  contentid    Int          @id @default(autoincrement())
  type         String?      @db.VarChar
  category     String?      @db.VarChar
  title        String?      @db.VarChar
  status       String?      @db.VarChar
  lang         String?      @db.VarChar(5)
  body         String?
  placeholders Json?
  description  String?
  mediaurl     String?      @db.VarChar
  createdat    DateTime?    @default(now()) @db.Timestamp(6)
  updatedat    DateTime?    @db.Timestamp(6)
  expiresat    DateTime?    @db.Timestamp(6)
  isdeleted    Boolean?     @default(false)
  contenttag   contenttag[]
  keymapping   keymapping[]
}

model contenttag {
  contentid Int
  tagid     Int
  content   content @relation(fields: [contentid], references: [contentid], onDelete: Cascade, onUpdate: NoAction)
  tag       tag     @relation(fields: [tagid], references: [tagid], onDelete: Cascade, onUpdate: NoAction)

  @@id([contentid, tagid])
}

model deliverlog {
  deliverid       Int       @id @default(autoincrement())
  messageid       Int
  deliverstatus   String?   @default("pending") @db.VarChar
  retrycount      Int?      @default(0)
  lastattemptat   DateTime? @db.Timestamp(6)
  nextretryat     DateTime? @db.Timestamp(6)
  provider_msg_id String?   @db.VarChar
  error_message   String?
  createdat       DateTime? @default(now()) @db.Timestamp(6)
  message         message   @relation(fields: [messageid], references: [messageid], onDelete: Cascade, onUpdate: NoAction)
}

model fallback {
  fallbackid   Int        @id @default(autoincrement())
  scope        String     @db.VarChar
  value        String?    @db.VarChar
  contentkeyid String     @db.VarChar
  userflowid   Int
  keymapping   keymapping @relation(fields: [contentkeyid, userflowid], references: [contentkeyid, userflowid], onDelete: Cascade, onUpdate: NoAction, map: "fallback_contentkeyid_fkey")
}

model keymapping {
  contentkeyid                                                                  String            @db.VarChar
  contentid                                                                     Int
  userflowid                                                                    Int
  ui_metadata                                                                   Json?             @default("{}")
  allowedinput                                                                  allowedinput[]
  branchrule                                                                    branchrule[]
  campaign                                                                      campaign[]
  fallback                                                                      fallback[]
  flow_transition_flow_transition_from_contentkeyid_from_userflowidTokeymapping flow_transition[] @relation("flow_transition_from_contentkeyid_from_userflowidTokeymapping")
  flow_transition_flow_transition_to_contentkeyid_to_userflowidTokeymapping     flow_transition[] @relation("flow_transition_to_contentkeyid_to_userflowidTokeymapping")
  content                                                                       content           @relation(fields: [contentid], references: [contentid], onUpdate: NoAction)
  userflow                                                                      userflow          @relation(fields: [userflowid], references: [userflowid], onDelete: Cascade, onUpdate: NoAction)

  @@id([contentkeyid, userflowid])
}

model keyword {
  keywordid  Int      @id @default(autoincrement())
  value      String   @unique @db.VarChar
  campaignid Int
  campaign   campaign @relation(fields: [campaignid], references: [campaignid], onDelete: Cascade, onUpdate: NoAction)
}

model message {
  messageid         Int              @id @default(autoincrement())
  campaignid        Int?
  campaignsessionid Int?
  contactid         Int?
  contentkeyid      String?          @db.VarChar
  direction         String           @db.VarChar
  senderid          String?
  receiverid        String?
  content_type      String?          @default("text") @db.VarChar
  message_content   String?
  payload_json      String?
  message_status    String?          @default("pending") @db.VarChar
  provider_msg_id   String?          @db.VarChar
  error_message     String?
  timestamp         DateTime?        @default(now()) @db.Timestamp(6)
  deliverlog        deliverlog[]
  campaign          campaign?        @relation(fields: [campaignid], references: [campaignid], onUpdate: NoAction)
  campaignsession   campaignsession? @relation(fields: [campaignsessionid], references: [campaignsessionid], onUpdate: NoAction)
  contact           contact?         @relation(fields: [contactid], references: [contactid], onUpdate: NoAction)
}

model sessionlog {
  logid             Int             @id @default(autoincrement())
  campaignsessionid Int
  contentkeyid      String?         @db.VarChar
  detail            String?         @db.VarChar
  loggedat          DateTime?       @default(now()) @db.Timestamp(6)
  campaignsession   campaignsession @relation(fields: [campaignsessionid], references: [campaignsessionid], onDelete: Cascade, onUpdate: NoAction)
}

model sessiontoken {
  tokenid    Int         @id @default(autoincrement())
  adminid    Int?
  roletype   String      @db.VarChar
  tokenvalue String      @db.VarChar
  issuedat   DateTime?   @default(now()) @db.Timestamp(6)
  expiryat   DateTime?   @db.Timestamp(6)
  is_revoked Boolean?    @default(false)
  lastusedat DateTime?   @db.Timestamp(6)
  createdby  String?     @db.VarChar
  createdat  DateTime?   @default(now()) @db.Timestamp(6)
  admin      admin?      @relation(fields: [adminid], references: [adminid], onUpdate: NoAction)
  token_log  token_log[]
}

model tag {
  tagid      Int          @id @default(autoincrement())
  name       String       @unique @db.VarChar
  isdeleted  Boolean      @default(false)
  createdat  DateTime     @default(now()) @db.Timestamptz(6)
  updatedat  DateTime     @default(now()) @db.Timestamptz(6)
  contenttag contenttag[]
}

model targetregion {
  regionid   Int        @id @default(autoincrement())
  regionname String     @db.VarChar
  regioncode String     @db.VarChar
  campaign   campaign[]
  contact    contact[]
}

model token_log {
  logid        Int           @id @default(autoincrement())
  tokenid      Int?
  action       String?       @db.VarChar
  ipaddress    String?       @db.VarChar
  useragent    String?
  logtime      DateTime?     @default(now()) @db.Timestamp(6)
  sessiontoken sessiontoken? @relation(fields: [tokenid], references: [tokenid], onDelete: Cascade, onUpdate: NoAction)
}

model userflow {
  userflowid                                                Int               @id @default(autoincrement())
  userflowname                                              String            @db.VarChar
  description                                               String?
  status                                                    String?           @default("Draft") @db.VarChar
  createdat                                                 DateTime?         @default(now()) @db.Timestamp(6)
  updatedat                                                 DateTime?         @db.Timestamp(6)
  entry_contentkeyid                                        String?           @db.VarChar
  fallback_contentkeyid                                     String?           @db.VarChar
  flow_type                                                 String            @default("CAMPAIGN") @db.VarChar
  branchrule_branchrule_next_userflowidTouserflow           branchrule[]      @relation("branchrule_next_userflowidTouserflow")
  branchrule_branchrule_userflowidTouserflow                branchrule[]      @relation("branchrule_userflowidTouserflow")
  campaign                                                  campaign[]
  campaignsession                                           campaignsession[]
  flow_transition_flow_transition_from_userflowidTouserflow flow_transition[] @relation("flow_transition_from_userflowidTouserflow")
  flow_transition_flow_transition_to_userflowidTouserflow   flow_transition[] @relation("flow_transition_to_userflowidTouserflow")
  keymapping                                                keymapping[]
  system_flow                                               system_flow[]
  system_keyword                                            system_keyword[]
}

model whatsapp_config {
  id                Int       @id @default(autoincrement())
  display_name      String?   @db.VarChar
  phone_number      String    @db.VarChar
  phone_number_id   String    @db.VarChar
  waba_id           String?   @db.VarChar
  verify_token      String    @db.VarChar
  api_version       String?   @default("v21.0") @db.VarChar
  is_active         Boolean?  @default(true)
  createdat         DateTime? @default(now()) @db.Timestamp(6)
  updatedat         DateTime? @db.Timestamp(6)
  updatedby_adminid Int?
  admin             admin?    @relation(fields: [updatedby_adminid], references: [adminid], onUpdate: NoAction)
}

model flow_transition {
  transitionid                                                             Int        @id @default(autoincrement())
  from_userflowid                                                          Int
  from_contentkeyid                                                        String     @db.VarChar
  to_userflowid                                                            Int
  to_contentkeyid                                                          String     @db.VarChar
  transition_type                                                          String     @default("AUTO") @db.VarChar
  condition_value                                                          String?    @db.VarChar
  priority                                                                 Int?       @default(1)
  is_active                                                                Boolean?   @default(true)
  createdat                                                                DateTime?  @default(now()) @db.Timestamp(6)
  keymapping_flow_transition_from_contentkeyid_from_userflowidTokeymapping keymapping @relation("flow_transition_from_contentkeyid_from_userflowidTokeymapping", fields: [from_contentkeyid, from_userflowid], references: [contentkeyid, userflowid], onDelete: Cascade, onUpdate: NoAction)
  userflow_flow_transition_from_userflowidTouserflow                       userflow   @relation("flow_transition_from_userflowidTouserflow", fields: [from_userflowid], references: [userflowid], onDelete: Cascade, onUpdate: NoAction)
  keymapping_flow_transition_to_contentkeyid_to_userflowidTokeymapping     keymapping @relation("flow_transition_to_contentkeyid_to_userflowidTokeymapping", fields: [to_contentkeyid, to_userflowid], references: [contentkeyid, userflowid], onUpdate: NoAction)
  userflow_flow_transition_to_userflowidTouserflow                         userflow   @relation("flow_transition_to_userflowidTouserflow", fields: [to_userflowid], references: [userflowid], onDelete: Cascade, onUpdate: NoAction)
}

model staff_privilege {
  privilegeid Int     @id @default(autoincrement())
  adminid     Int
  resource    String  @db.VarChar
  view        Boolean @default(false)
  create      Boolean @default(false)
  update      Boolean @default(false)
  archive     Boolean @default(false)
  admin       admin   @relation(fields: [adminid], references: [adminid], onDelete: Cascade, onUpdate: NoAction)
}

model system_keyword {
  keyword      String       @id @db.VarChar
  userflowid   Int
  is_active    Boolean?     @default(true)
  createdat    DateTime?    @default(now()) @db.Timestamp(6)
  systemflowid Int?
  system_flow  system_flow? @relation(fields: [systemflowid], references: [systemflowid])
  userflow     userflow     @relation(fields: [userflowid], references: [userflowid], onDelete: Cascade, onUpdate: NoAction)

  @@index([systemflowid], map: "idx_system_keyword_systemflowid")
}

model system_flow {
  systemflowid   Int              @id @default(autoincrement())
  code           String           @unique @db.VarChar(50)
  userflowid     Int
  is_active      Boolean?         @default(true)
  createdat      DateTime?        @default(now()) @db.Timestamp(6)
  userflow       userflow         @relation(fields: [userflowid], references: [userflowid], onDelete: NoAction, onUpdate: NoAction)
  system_keyword system_keyword[]
}
