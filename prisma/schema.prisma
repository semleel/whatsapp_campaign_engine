generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model admin {
  adminid         Int               @id @default(autoincrement())
  name            String?           @db.VarChar(100)
  email           String            @unique @db.VarChar(255)
  password_hash   String            @db.VarChar(255)
  role            String?           @db.VarChar(50)
  phonenum        String?           @db.VarChar(20)
  createdat       DateTime?         @default(now()) @db.Timestamp(6)
  is_active       Boolean?          @default(true)
  campaign        campaign[]
  sessiontoken    sessiontoken[]
  whatsapp_config whatsapp_config[]
  staff_privilege staff_privilege[]
}

model staff_privilege {
  privilegeid Int     @id @default(autoincrement())
  adminid     Int
  resource    String  @db.VarChar(100)
  view        Boolean @default(false)
  create      Boolean @default(false)
  update      Boolean @default(false)
  archive     Boolean @default(false)
  admin       admin   @relation(fields: [adminid], references: [adminid], onDelete: Cascade, onUpdate: NoAction)

  @@unique([adminid, resource], map: "ux_staff_privilege_admin_resource")
}

model allowedinput {
  allowedinputid Int        @id @default(autoincrement())
  triggerkey     String     @db.VarChar(100)
  allowedvalue   String     @db.VarChar(100)
  userflowid     Int
  keymapping     keymapping @relation(fields: [triggerkey, userflowid], references: [contentkeyid, userflowid], onDelete: Cascade, onUpdate: NoAction, map: "allowedinput_triggerkey_fkey")
  userflow       userflow   @relation(fields: [userflowid], references: [userflowid], onDelete: Cascade, onUpdate: NoAction)
}

model api {
  apiid                Int                    @id @default(autoincrement())
  name                 String                 @db.VarChar(150)
  description          String?                @db.VarChar(255)
  base_url             String                 @db.VarChar(255)
  path                 String                 @db.VarChar(255)
  method               String                 @db.VarChar(10)
  auth_type            String?                @default("none") @db.VarChar(20)
  auth_header_name     String?                @default("Authorization") @db.VarChar(100)
  auth_token           String?                @db.VarChar(500)
  timeout_ms           Int?                   @default(5000)
  retry_enabled        Boolean?               @default(false)
  retry_count          Int?                   @default(0)
  is_active            Boolean?               @default(true)
  lastupdated          DateTime?              @db.Timestamp(6)
  api_log              api_log[]
  apiparameter         apiparameter[]
  campaign_api_mapping campaign_api_mapping[]
}

model api_log {
  logid             Int              @id @default(autoincrement())
  apiid             Int?
  campaignid        Int?
  campaignsessionid Int?
  contactid         Int?
  request_url       String?
  request_body      String?
  response_body     String?
  response_code     Int?
  status            String?          @db.VarChar(20)
  error_message     String?
  called_at         DateTime?        @default(now()) @db.Timestamp(6)
  api               api?             @relation(fields: [apiid], references: [apiid], onDelete: NoAction, onUpdate: NoAction)
  campaign          campaign?        @relation(fields: [campaignid], references: [campaignid], onDelete: NoAction, onUpdate: NoAction)
  campaignsession   campaignsession? @relation(fields: [campaignsessionid], references: [campaignsessionid], onDelete: NoAction, onUpdate: NoAction)
  contact           contact?         @relation(fields: [contactid], references: [contactid], onDelete: NoAction, onUpdate: NoAction)
}

model apiparameter {
  paramid       Int      @id @default(autoincrement())
  apiid         Int
  location      String   @db.VarChar(10)
  key           String   @db.VarChar(100)
  valuesource   String   @db.VarChar(20)
  valuepath     String?  @db.VarChar(255)
  constantvalue String?  @db.VarChar(500)
  required      Boolean? @default(false)
  api           api      @relation(fields: [apiid], references: [apiid], onDelete: NoAction, onUpdate: NoAction)
}

model branchrule {
  branchruleid                                  Int        @id @default(autoincrement())
  triggerkey                                    String     @db.VarChar(100)
  inputvalue                                    String     @db.VarChar(100)
  nextkey                                       String     @db.VarChar(100)
  priority                                      Int?       @default(1)
  userflowid                                    Int
  next_userflowid                               Int?
  userflow_branchrule_next_userflowidTouserflow userflow?  @relation("branchrule_next_userflowidTouserflow", fields: [next_userflowid], references: [userflowid], onDelete: NoAction, onUpdate: NoAction)
  keymapping                                    keymapping @relation(fields: [triggerkey, userflowid], references: [contentkeyid, userflowid], onDelete: Cascade, onUpdate: NoAction, map: "branchrule_triggerkey_fkey")
  userflow_branchrule_userflowidTouserflow      userflow   @relation("branchrule_userflowidTouserflow", fields: [userflowid], references: [userflowid], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userflowid, triggerkey, inputvalue], map: "ux_branchrule_unique")
}

model campaign {
  campaignid           Int                    @id @default(autoincrement())
  campaignname         String                 @db.VarChar(150)
  objective            String?                @db.VarChar(255)
  targetregionid       Int?
  status               String?                @default("Draft") @db.VarChar(20)
  createdby_adminid    Int?
  createdat            DateTime?              @default(now()) @db.Timestamp(6)
  updatedat            DateTime?              @db.Timestamp(6)
  start_at             DateTime?              @db.Timestamp(6)
  end_at               DateTime?              @db.Timestamp(6)
  contentkeyid         String?                @db.VarChar(100)
  userflowid           Int?
  api_log              api_log[]
  keymapping           keymapping?            @relation(fields: [contentkeyid, userflowid], references: [contentkeyid, userflowid], onUpdate: NoAction, map: "campaign_contentkeyid_fkey")
  admin                admin?                 @relation(fields: [createdby_adminid], references: [adminid], onDelete: NoAction, onUpdate: NoAction)
  targetregion         targetregion?          @relation(fields: [targetregionid], references: [regionid], onDelete: NoAction, onUpdate: NoAction)
  campaign_api_mapping campaign_api_mapping[]
  campaign_content     campaign_content[]
  campaignsession      campaignsession[]
  keyword              keyword[]
}

model campaign_api_mapping {
  mappingid                                                                   Int         @id @default(autoincrement())
  campaignid                                                                  Int
  contentkeyid                                                                String      @db.VarChar(100)
  apiid                                                                       Int
  success_contentkeyid                                                        String?     @db.VarChar(100)
  error_contentkeyid                                                          String?     @db.VarChar(100)
  is_active                                                                   Boolean?    @default(true)
  api                                                                         api         @relation(fields: [apiid], references: [apiid], onDelete: NoAction, onUpdate: NoAction)
  campaign                                                                    campaign    @relation(fields: [campaignid], references: [campaignid], onDelete: NoAction, onUpdate: NoAction)
  keymapping_campaign_api_mapping_contentkeyid_campaignidTokeymapping         keymapping  @relation("campaign_api_mapping_contentkeyid_campaignidTokeymapping", fields: [contentkeyid, campaignid], references: [contentkeyid, userflowid], onDelete: NoAction, onUpdate: NoAction, map: "campaign_api_mapping_contentkeyid_fkey")
  keymapping_campaign_api_mapping_error_contentkeyid_campaignidTokeymapping   keymapping? @relation("campaign_api_mapping_error_contentkeyid_campaignidTokeymapping", fields: [error_contentkeyid, campaignid], references: [contentkeyid, userflowid], onDelete: NoAction, onUpdate: NoAction, map: "campaign_api_mapping_error_contentkeyid_fkey")
  keymapping_campaign_api_mapping_success_contentkeyid_campaignidTokeymapping keymapping? @relation("campaign_api_mapping_success_contentkeyid_campaignidTokeymapping", fields: [success_contentkeyid, campaignid], references: [contentkeyid, userflowid], onDelete: NoAction, onUpdate: NoAction, map: "campaign_api_mapping_success_contentkeyid_fkey")
}

model campaign_content {
  campaigncontentid Int    @id @default(autoincrement())
  campaignid        Int
  contentkeyid      String @db.VarChar(100)
  contentid         Int

  campaign campaign @relation(fields: [campaignid], references: [campaignid], onDelete: NoAction, onUpdate: NoAction)

  @@unique([campaignid, contentkeyid])
}

model campaignsession {
  campaignsessionid  Int          @id @default(autoincrement())
  contactid          Int
  campaignid         Int
  checkpoint         String?      @db.VarChar(100)
  sessionstatus      String?      @default("ACTIVE") @db.VarChar(20)
  createdat          DateTime?    @default(now()) @db.Timestamp(6)
  lastactiveat       DateTime?    @db.Timestamp(6)
  current_userflowid Int?
  api_log            api_log[]
  campaign           campaign     @relation(fields: [campaignid], references: [campaignid], onDelete: NoAction, onUpdate: NoAction)
  contact            contact      @relation(fields: [contactid], references: [contactid], onDelete: NoAction, onUpdate: NoAction)
  userflow           userflow?    @relation(fields: [current_userflowid], references: [userflowid], onDelete: Restrict, onUpdate: NoAction)
  message            message[]
  sessionlog         sessionlog[]
}

model contact {
  contactid       Int               @id @default(autoincrement())
  name            String?           @db.VarChar(100)
  phonenum        String            @unique @db.VarChar(20)
  email           String?           @db.VarChar(255)
  regionid        Int?
  createdat       DateTime?         @default(now()) @db.Timestamp(6)
  tos_accepted    Boolean?          @default(false)
  lang            String?           @db.VarChar(5)
  api_log         api_log[]
  campaignsession campaignsession[]
  targetregion    targetregion?     @relation(fields: [regionid], references: [regionid], onDelete: NoAction, onUpdate: NoAction)
  message         message[]
}

model content {
  contentid    Int          @id @default(autoincrement())
  type         String?      @db.VarChar(50)
  category     String?      @db.VarChar(100)
  title        String?      @db.VarChar(150)
  status       String?      @db.VarChar(20)
  lang         String?      @db.Char(5)
  body         String?
  placeholders Json?
  description  String?
  mediaurl     String?      @db.VarChar(255)
  createdat    DateTime?    @default(now()) @db.Timestamp(6)
  updatedat    DateTime?    @db.Timestamp(6)
  expiresat    DateTime?    @db.Timestamp(6)
  isdeleted    Boolean?     @default(false)
  contenttag   contenttag[]
  keymapping   keymapping[]
}

model contenttag {
  contentid Int
  tagid     Int
  content   content @relation(fields: [contentid], references: [contentid], onDelete: NoAction, onUpdate: NoAction)
  tag       tag     @relation(fields: [tagid], references: [tagid], onDelete: NoAction, onUpdate: NoAction)

  @@id([contentid, tagid])
}

model deliverlog {
  deliverid       Int       @id @default(autoincrement())
  messageid       Int
  deliverstatus   String?   @default("pending") @db.VarChar(20)
  retrycount      Int?      @default(0)
  lastattemptat   DateTime? @db.Timestamp(6)
  nextretryat     DateTime? @db.Timestamp(6)
  provider_msg_id String?   @db.VarChar(100)
  error_message   String?
  createdat       DateTime? @default(now()) @db.Timestamp(6)
  message         message   @relation(fields: [messageid], references: [messageid], onDelete: NoAction, onUpdate: NoAction)
}

model fallback {
  fallbackid   Int        @id @default(autoincrement())
  scope        String     @db.VarChar(20)
  value        String?    @db.VarChar(100)
  contentkeyid String     @db.VarChar(100)
  userflowid   Int
  keymapping   keymapping @relation(fields: [contentkeyid, userflowid], references: [contentkeyid, userflowid], onDelete: Cascade, onUpdate: NoAction, map: "fallback_contentkeyid_fkey")
  userflow     userflow   @relation(fields: [userflowid], references: [userflowid], onDelete: Cascade, onUpdate: NoAction)
}

model keymapping {
  contentkeyid                                                                          String                 @db.VarChar(100)
  contentid                                                                             Int
  userflowid                                                                            Int
  allowedinput                                                                          allowedinput[]
  branchrule                                                                            branchrule[]
  campaign                                                                              campaign[]
  campaign_api_mapping_campaign_api_mapping_contentkeyid_campaignidTokeymapping         campaign_api_mapping[] @relation("campaign_api_mapping_contentkeyid_campaignidTokeymapping")
  campaign_api_mapping_campaign_api_mapping_error_contentkeyid_campaignidTokeymapping   campaign_api_mapping[] @relation("campaign_api_mapping_error_contentkeyid_campaignidTokeymapping")
  campaign_api_mapping_campaign_api_mapping_success_contentkeyid_campaignidTokeymapping campaign_api_mapping[] @relation("campaign_api_mapping_success_contentkeyid_campaignidTokeymapping")
  fallback                                                                              fallback[]
  content                                                                               content                @relation(fields: [contentid], references: [contentid], onDelete: NoAction, onUpdate: NoAction)
  userflow                                                                              userflow               @relation(fields: [userflowid], references: [userflowid], onDelete: Cascade, onUpdate: NoAction)

  @@id([contentkeyid, userflowid])
}

model keyword {
  keywordid  Int      @id @default(autoincrement())
  value      String   @unique(map: "keyword_value_unique") @db.VarChar(100)
  campaignid Int
  campaign   campaign @relation(fields: [campaignid], references: [campaignid], onDelete: NoAction, onUpdate: NoAction)
}

model message {
  messageid         Int              @id @default(autoincrement())
  campaignid        Int?
  campaignsessionid Int?
  contactid         Int?
  contentkeyid      String?          @db.VarChar(100)
  direction         String           @db.VarChar(10)
  senderid          String?
  receiverid        String?
  content_type      String?          @default("text") @db.VarChar(50)
  message_content   String?
  payload_json      String?
  message_status    String?          @default("pending") @db.VarChar(20)
  provider_msg_id   String?          @db.VarChar(100)
  error_message     String?
  timestamp         DateTime?        @default(now()) @db.Timestamp(6)
  deliverlog        deliverlog[]
  campaignsession   campaignsession? @relation(fields: [campaignsessionid], references: [campaignsessionid], onDelete: NoAction, onUpdate: NoAction)
  contact           contact?         @relation(fields: [contactid], references: [contactid], onDelete: NoAction, onUpdate: NoAction)
}

model sessionlog {
  logid             Int             @id @default(autoincrement())
  campaignsessionid Int
  contentkeyid      String?         @db.VarChar(100)
  detail            String?         @db.VarChar(255)
  loggedat          DateTime?       @default(now()) @db.Timestamp(6)
  campaignsession   campaignsession @relation(fields: [campaignsessionid], references: [campaignsessionid], onDelete: NoAction, onUpdate: NoAction)
}

model sessiontoken {
  tokenid    Int         @id @default(autoincrement())
  adminid    Int?
  roletype   String      @db.VarChar(20)
  tokenvalue String      @db.VarChar(500)
  issuedat   DateTime?   @default(now()) @db.Timestamp(6)
  expiryat   DateTime?   @db.Timestamp(6)
  is_revoked Boolean?    @default(false)
  lastusedat DateTime?   @db.Timestamp(6)
  createdby  String?     @db.VarChar(100)
  createdat  DateTime?   @default(now()) @db.Timestamp(6)
  admin      admin?      @relation(fields: [adminid], references: [adminid], onDelete: NoAction, onUpdate: NoAction)
  token_log  token_log[]
}

model tag {
  tagid      Int          @id @default(autoincrement())
  name       String       @unique @db.VarChar(50)
  isdeleted  Boolean      @default(false)
  createdat  DateTime     @default(now()) @db.Timestamptz(6)
  updatedat  DateTime     @default(now()) @db.Timestamptz(6)
  contenttag contenttag[]
}

model targetregion {
  regionid   Int        @id @default(autoincrement())
  regionname String     @db.VarChar(100)
  regioncode String     @db.VarChar(100)
  campaign   campaign[]
  contact    contact[]
}

model token_log {
  logid        Int           @id @default(autoincrement())
  tokenid      Int?
  action       String?       @db.VarChar(50)
  ipaddress    String?       @db.VarChar(50)
  useragent    String?
  logtime      DateTime?     @default(now()) @db.Timestamp(6)
  sessiontoken sessiontoken? @relation(fields: [tokenid], references: [tokenid], onDelete: NoAction, onUpdate: NoAction)
}

model userflow {
  userflowid                                      Int               @id @default(autoincrement())
  userflowname                                    String            @db.VarChar(100)
  description                                     String?
  status                                          String?           @default("Draft") @db.VarChar(20)
  createdat                                       DateTime?         @default(now()) @db.Timestamp(6)
  updatedat                                       DateTime?         @db.Timestamp(6)
  entry_contentkeyid                              String?           @db.VarChar(100)
  fallback_contentkeyid                           String?           @db.VarChar(100)
  allowedinput                                    allowedinput[]
  branchrule_branchrule_next_userflowidTouserflow branchrule[]      @relation("branchrule_next_userflowidTouserflow")
  branchrule_branchrule_userflowidTouserflow      branchrule[]      @relation("branchrule_userflowidTouserflow")
  campaign                                        campaign[]
  campaignsession                                 campaignsession[]
  fallback                                        fallback[]
  keymapping                                      keymapping[]
}

model whatsapp_config {
  id                Int       @id @default(autoincrement())
  display_name      String?   @db.VarChar(100)
  phone_number      String    @db.VarChar(20)
  phone_number_id   String    @db.VarChar(50)
  waba_id           String?   @db.VarChar(50)
  verify_token      String    @db.VarChar(255)
  api_version       String?   @default("v21.0") @db.VarChar(10)
  is_active         Boolean?  @default(true)
  createdat         DateTime? @default(now()) @db.Timestamp(6)
  updatedat         DateTime? @db.Timestamp(6)
  updatedby_adminid Int?
  admin             admin?    @relation(fields: [updatedby_adminid], references: [adminid], onDelete: NoAction, onUpdate: NoAction)
}
